<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VisBug Core - Phase 2 Selection Test</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: system-ui, -apple-system, sans-serif;
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
        background: #f5f5f5;
      }

      .container {
        background: white;
        border-radius: 8px;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }

      h1 {
        color: #333;
        margin-top: 0;
      }

      .status {
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        font-weight: 500;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .toolbar {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 4px;
      }

      button {
        padding: 0.5rem 1rem;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }

      button:hover:not(:disabled) {
        background: #f5f5f5;
        border-color: #aaa;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      button.active {
        background: #0366d6;
        color: white;
        border-color: #0366d6;
      }

      .editable-area {
        border: 2px dashed #ddd;
        padding: 2rem;
        min-height: 400px;
        background: #fafafa;
        border-radius: 4px;
        position: relative;
      }

      .editable-area h2 {
        color: #0366d6;
        margin-top: 0;
      }

      .editable-area .card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 1rem;
        margin: 1rem 0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .editable-area .card h3 {
        margin-top: 0;
        color: #333;
      }

      .editable-area .highlight {
        background: #fff3cd;
        padding: 0.5rem;
        border-left: 3px solid #ffc107;
        margin: 1rem 0;
      }

      .editable-area img {
        max-width: 200px;
        border-radius: 4px;
        margin: 1rem 0;
      }

      .info-panel {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 4px;
        margin-top: 1rem;
        font-family: "Courier New", monospace;
        font-size: 12px;
      }

      .info-panel dt {
        font-weight: bold;
        color: #666;
        margin-top: 0.5rem;
      }

      .info-panel dd {
        margin-left: 0;
        color: #333;
        margin-bottom: 0.5rem;
      }

      .instructions {
        background: #e7f3ff;
        border-left: 4px solid #0366d6;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 4px;
      }

      .instructions h4 {
        margin-top: 0;
        color: #0366d6;
      }

      .instructions ul {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
      }

      .instructions li {
        margin: 0.25rem 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üêû VisBug Core - Phase 2 Selection System Test</h1>

      <div id="status" class="status"></div>

      <div class="instructions">
        <h4>Test Instructions:</h4>
        <ul>
          <li><strong>Click</strong> on any element below to select it</li>
          <li><strong>Shift+Click</strong> to add/remove elements to selection</li>
          <li><strong>Hover</strong> over elements to see hover state</li>
          <li><strong>Esc</strong> to clear selection</li>
          <li><strong>Tab/Shift+Tab</strong> to navigate between siblings</li>
          <li><strong>Enter/Shift+Enter</strong> to navigate to child/parent</li>
          <li><strong>Cmd/Ctrl+D</strong> to duplicate selected element</li>
          <li><strong>Delete/Backspace</strong> to delete selected element</li>
        </ul>
      </div>
    </div>

    <div class="container">
      <div class="toolbar" id="toolbar">
        <button id="btn-select" onclick="logSelection()">Log Selection</button>
        <button id="btn-clear" onclick="clearAll()">Clear Selection</button>
        <span style="flex-grow: 1"></span>
        <button id="btn-undo" onclick="undo()" disabled>Undo</button>
        <button id="btn-redo" onclick="redo()" disabled>Redo</button>
      </div>

      <div id="editable-area" class="editable-area">
        <h2>Selectable Content Area</h2>

        <p>This is a paragraph you can select. Try clicking on it!</p>

        <div class="card">
          <h3>Card Title</h3>
          <p>
            This is a card with multiple child elements. You can select the card or its children.
          </p>
          <button>Button Inside Card</button>
        </div>

        <div class="highlight">
          <strong>Important:</strong> This is a highlighted section with <em>nested elements</em>.
        </div>

        <div class="card">
          <h3>Another Card</h3>
          <p>Try selecting this card and then using Tab to navigate to the next sibling.</p>
        </div>

        <img
          src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='150'%3E%3Crect fill='%230366d6' width='200' height='150'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='white' font-family='sans-serif' font-size='20'%3EPlaceholder%3C/text%3E%3C/svg%3E"
          alt="Placeholder"
        />

        <ul>
          <li>List item 1</li>
          <li>List item 2</li>
          <li>List item 3</li>
        </ul>
      </div>

      <div class="info-panel">
        <dl id="editor-info"></dl>
      </div>
    </div>

    <div class="container">
      <h3>Phase 2 Test Results:</h3>
      <div class="info-panel">
        <dl id="test-results"></dl>
      </div>
    </div>

    <script type="module">
      import { VisBugEditor, VERSION } from "./dist/visbug-editor.browser.js";

      const statusEl = document.getElementById("status");
      const testResultsEl = document.getElementById("test-results");
      const editorInfoEl = document.getElementById("editor-info");

      // Store editor globally for button handlers
      window.editor = null;

      // Test results
      const results = [];

      function addResult(name, value) {
        results.push({ name, value });
        const dt = document.createElement("dt");
        dt.textContent = name + ":";
        const dd = document.createElement("dd");
        dd.textContent = value;
        testResultsEl.appendChild(dt);
        testResultsEl.appendChild(dd);
      }

      function updateEditorInfo() {
        editorInfoEl.innerHTML = "";

        const selected = window.editor?.getSelectedElements() || [];

        const info = {
          "Selected Elements": selected.length,
          Selection: selected.map((el) => el.tagName.toLowerCase()).join(", ") || "none",
          "Can Undo": window.editor?.canUndo() || false,
          "Can Redo": window.editor?.canRedo() || false,
          "Is Initialized": window.editor?.isInitialized || false,
        };

        Object.entries(info).forEach(([key, value]) => {
          const dt = document.createElement("dt");
          dt.textContent = key + ":";
          const dd = document.createElement("dd");
          dd.textContent = String(value);
          editorInfoEl.appendChild(dt);
          editorInfoEl.appendChild(dd);
        });
      }

      function updateButtons() {
        document.getElementById("btn-undo").disabled = !window.editor?.canUndo();
        document.getElementById("btn-redo").disabled = !window.editor?.canRedo();
      }

      // Expose to global scope for inline onclick handlers
      window.updateEditorInfoGlobal = updateEditorInfo;
      window.updateButtonsGlobal = updateButtons;

      // Run tests
      try {
        // Test 1: Module imports
        addResult("Module Import", "‚úÖ Success");
        addResult("Version", VERSION);

        // Test 2: VisBugEditor with Selection
        const container = document.getElementById("editable-area");
        window.editor = new VisBugEditor({
          container: container,
          mode: "div", // Use div mode so we can see the content
          onSelectionChange: (elements) => {
            console.log("Selection changed:", elements);
            updateEditorInfo();
            updateButtons();
          },
          onChange: (state) => {
            console.log("Change:", state);
            updateButtons();
          },
        });

        addResult("VisBugEditor", "‚úÖ Instantiated");
        addResult("Selection Engine", window.editor.selectorEngine ? "‚úÖ Active" : "‚ùå Not active");

        // Test 3: Selection API
        const selectionMethods = [
          "selectElement",
          "selectElements",
          "getSelectedElements",
          "clearSelection",
        ];

        const missingMethods = selectionMethods.filter(
          (method) => typeof window.editor[method] !== "function"
        );

        if (missingMethods.length === 0) {
          addResult("Selection API", "‚úÖ All methods present");
        } else {
          addResult("Selection API", "‚ùå Missing: " + missingMethods.join(", "));
        }

        // Test 4: Check if custom elements are registered
        const customElements = ["visbug-handles", "visbug-label", "visbug-hover", "visbug-overlay"];

        const registeredElements = customElements.filter((name) => window.customElements.get(name));

        addResult(
          "Custom Elements",
          `${registeredElements.length}/${customElements.length} registered`
        );

        // Show success
        statusEl.className = "status success";
        statusEl.innerHTML = `
        <strong>‚úÖ Phase 2 Complete - Selection System Active!</strong><br>
        Try clicking on elements in the editable area below.
      `;

        // Update info panel
        updateEditorInfo();

        // Initial button states
        updateButtons();
      } catch (error) {
        statusEl.className = "status error";
        statusEl.textContent = "‚ùå Error: " + error.message;
        console.error(error);
        addResult("Error", error.message);
      }
    </script>

    <script>
      // Global button handlers (outside module scope)
      function logSelection() {
        const selected = window.editor?.getSelectedElements() || [];
        console.log("Currently selected:", selected);
        alert(
          `Selected ${selected.length} element(s):\n${selected.map((el) => el.tagName).join(", ")}`
        );
      }

      function clearAll() {
        window.editor?.clearSelection();
        // Trigger info update if the function exists
        if (window.updateEditorInfoGlobal) {
          window.updateEditorInfoGlobal();
        }
      }

      function undo() {
        window.editor?.undo();
        if (window.updateButtonsGlobal) {
          window.updateButtonsGlobal();
        }
        if (window.updateEditorInfoGlobal) {
          window.updateEditorInfoGlobal();
        }
      }

      function redo() {
        window.editor?.redo();
        if (window.updateButtonsGlobal) {
          window.updateButtonsGlobal();
        }
        if (window.updateEditorInfoGlobal) {
          window.updateEditorInfoGlobal();
        }
      }
    </script>
  </body>
</html>
